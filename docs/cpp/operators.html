<!DOCTYPE html>
<html lang="ru">
	<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
	<meta name="description" content="IT простым языком">
	<meta name="generator" content="HUGO">

	<meta name="theme-color" content="#ffffff">

    
    <link rel="stylesheet" href="/sass/main.scss">
    <title> IT простым языком </title>
</head>

<body>
	<div id="top"/>
<header>
    <div align="center">
        +---------------------------+<br>
        |.-------------------------.|<br>
        ||&nbsp;<a href="/">kee_reel@blog</a>:~$ cd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||<br>
        ||&nbsp;<a href="/c.html">c</a>&nbsp;&nbsp;<a href="/cpp.html">c++</a>&nbsp;&nbsp;<a href="/python.html">python</a>&nbsp;&nbsp;<a href="/linux.html">linux</a>&nbsp;&nbsp;&nbsp;||<br>
        ||&nbsp;<a href="/opengl.html">opengl</a>&nbsp;&nbsp;<a href="/sql.html">sql</a>&nbsp;&nbsp;<a href="/network.html">networks</a>&nbsp;&nbsp;&nbsp;||<br>
        ||&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||<br>
        ||&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="/about.html">обо_мне</a>&nbsp;||<br>
        |.-------------------------.|<br>
        +-::---------------------::-+<br>
        .---------------------------.<br>
        &nbsp;//&nbsp;/o<a href="/links.html">o</a>oooooooooooooooooooo\\&nbsp;\\&nbsp;<br>
        &nbsp;//&nbsp;/oooooooooooooooooooooooo\\&nbsp;\\&nbsp;<br>
        //-------------------------------\\<br>
        \\-------------------------------//<br>
    </div>
    <hr>
</header>

		
	<div id="wrapper">
		<div class="container">
			<section id="main_content">
    
    
        <div style="display: flex; justify-content: space-between;">
            
                <a href="https://kee-reel.com/cpp/classes.html">◀ Классы</a>
            
            
                <a href="https://kee-reel.com/cpp/constructors.html">Конструкторы, оператор присваивания и деструктор ▶</a>
            
        </div>
        <hr>
    
    <h1>C&#43;&#43;. Переопределение операторов</h1>
    
    
        <h3>Время чтения: 7 мин</h3>
    
    <p>Прежде чем я расскажу про операторы в классах, давай я приведу пример, от которого будем отталкиваться.</p>
<blockquote>
<p>Я буду основываться на коде, приведённом в основной <a href="../classes">статье</a> про классы.</p>
</blockquote>
<p>Например, я хочу добавить возможность переливать кофе из одной кружки в другую (ты очень любишь кофе, а твой друг не допил).</p>
<p>Я мог бы добавить в класс Coffee новый метод pour (англ. &ndash; налить):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="nf">pour</span><span class="p">(</span><span class="n">Coffee</span> <span class="o">&amp;</span><span class="n">other_cup</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Сравниваем адреса объектов, чтобы понять что это разные объекты
</span><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">other_cup</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Can&#39;t pour one cup into itself!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Сливаем только одинаковый тип кофе (чтобы не получить бурду)
</span><span class="c1"></span>    <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">m_type</span><span class="p">,</span> <span class="n">other_cup</span><span class="p">.</span><span class="n">m_type</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// Предположим, что у нас бесконечно глубокая кружка
</span><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Poured &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">other_cup</span><span class="p">.</span><span class="n">m_volume</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;ml of&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">m_type</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; from one cup to another.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
		<span class="n">m_volume</span> <span class="o">+=</span> <span class="n">other_cup</span><span class="p">.</span><span class="n">m_volume</span><span class="p">;</span>
		<span class="n">other_cup</span><span class="p">.</span><span class="n">m_volume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Coffee types &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">m_type</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; and &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">other_cup</span><span class="p">.</span><span class="n">m_type</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; doesn&#39;t match!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><blockquote>
<p>Смотри, я использовал &ldquo;this&rdquo; чтобы внутри метода получить адрес текущего объекта. Запомни &ldquo;this&rdquo; &ndash; он периодически пригождается.</p>
</blockquote>
<p>Теперь можно будет переливать из одной кружки в другую:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Coffee</span> <span class="n">c1</span><span class="p">(</span><span class="s">&#34;espresso&#34;</span><span class="p">,</span> <span class="o">+</span><span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span> 
    <span class="c1">// Created 50ml cup of hot espresso coffee.
</span><span class="c1"></span>    <span class="n">Coffee</span> <span class="n">c2</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="o">+</span><span class="mi">45</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
    <span class="c1">// Created 100ml cup of warm americano coffee.
</span><span class="c1"></span>    <span class="n">Coffee</span> <span class="n">c3</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="o">+</span><span class="mi">45</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
    <span class="c1">// Created 200ml cup of warm americano coffee.
</span><span class="c1"></span>    <span class="n">c3</span><span class="p">.</span><span class="n">pour</span><span class="p">(</span><span class="n">c3</span><span class="p">);</span>
    <span class="c1">// Can&#39;t pour one cup into itself!
</span><span class="c1"></span>    <span class="n">c3</span><span class="p">.</span><span class="n">pour</span><span class="p">(</span><span class="n">c1</span><span class="p">);</span>
    <span class="c1">// Coffee types americano and espresso doesn&#39;t match!
</span><span class="c1"></span>    <span class="n">c3</span><span class="p">.</span><span class="n">pour</span><span class="p">(</span><span class="n">c2</span><span class="p">);</span>
    <span class="c1">// Poured 100ml ofamericano from one cup to another.
</span><span class="c1"></span>    <span class="n">c2</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="c1">// No americano left :(
</span><span class="c1"></span>    <span class="n">c3</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="c1">// Drank 300ml of americano.
</span><span class="c1"></span>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// Destructed americano.
</span><span class="c1"></span>    <span class="c1">// Destructed americano.
</span><span class="c1"></span>    <span class="c1">// Destructed espresso.
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>Иногда, определённые методы вызываются очень часто, и чтобы облегчить работу с ними, можно, вместо использования обычного метода, можно переопределить оператор:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">void</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">Coffee</span> <span class="o">&amp;</span><span class="n">other_cup</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Сравниваем адреса объектов, чтобы понять что это разные объекты
</span><span class="c1"></span>    <span class="k">if</span><span class="p">(</span><span class="k">this</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">other_cup</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Can&#39;t pour one cup into itself!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Сливаем только одинаковый тип кофе (чтобы не получить бурду)
</span><span class="c1"></span>    <span class="k">else</span> <span class="nf">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">m_type</span><span class="p">,</span> <span class="n">other_cup</span><span class="p">.</span><span class="n">m_type</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// Предположим, что у нас бесконечно глубокая кружка
</span><span class="c1"></span>        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Poured &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">other_cup</span><span class="p">.</span><span class="n">m_volume</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;ml of&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">m_type</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; from one cup to another.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
		<span class="n">m_volume</span> <span class="o">+=</span> <span class="n">other_cup</span><span class="p">.</span><span class="n">m_volume</span><span class="p">;</span>
		<span class="n">other_cup</span><span class="p">.</span><span class="n">m_volume</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Coffee types &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">m_type</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; and &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">other_cup</span><span class="p">.</span><span class="n">m_type</span> <span class="o">&lt;&lt;</span> <span class="s">&#34; doesn&#39;t match!&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>А переливание кофе будет выглядеть так:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Coffee</span> <span class="nf">c1</span><span class="p">(</span><span class="s">&#34;espresso&#34;</span><span class="p">,</span> <span class="o">+</span><span class="mi">60</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span> 
<span class="c1">// Created 50ml cup of hot espresso coffee.
</span><span class="c1"></span><span class="n">Coffee</span> <span class="nf">c2</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="o">+</span><span class="mi">45</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="c1">// Created 100ml cup of warm americano coffee.
</span><span class="c1"></span><span class="n">Coffee</span> <span class="nf">c3</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="o">+</span><span class="mi">45</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
<span class="c1">// Created 200ml cup of warm americano coffee.
</span><span class="c1"></span><span class="n">c3</span> <span class="o">&lt;&lt;</span> <span class="n">c3</span><span class="p">;</span>
<span class="c1">// Can&#39;t pour one cup into itself!
</span><span class="c1"></span><span class="n">c3</span> <span class="o">&lt;&lt;</span> <span class="n">c1</span><span class="p">;</span>
<span class="c1">// Coffee types americano and espresso doesn&#39;t match!
</span><span class="c1"></span><span class="n">c3</span> <span class="o">&lt;&lt;</span> <span class="n">c2</span><span class="p">;</span>
<span class="c1">// Poured 100ml of americano from one cup to another.
</span><span class="c1"></span><span class="n">c2</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="c1">// Drank 0ml of americano.
</span><span class="c1"></span><span class="n">c3</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="c1">// Drank 300ml of americano.
</span><span class="c1"></span><span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// Destructed americano.
</span><span class="c1">// Destructed americano.
</span><span class="c1">// Destructed espresso.
</span></code></pre></div><p>Как видишь, не особо много поменялось &ndash; просто метод теперь вызывается иначе.</p>
<p>Мы можем переопределить почти все операторы (в примерах &ldquo;a&rdquo; &ndash; наш класс, &ldquo;b&rdquo; &ndash; параметр):</p>
<ul>
<li>Присваивания: <code>a = b</code>, <code>a += b</code>, <code>a -= b</code>, <code>a \*= b</code>, <code>a /= b</code>, <code>a %= b</code>, <code>a &amp;= b</code>, <code>a |= b</code>, <code>a ^= b</code>, <code>a &lt;&lt;= b</code>, <code>a &gt;&gt;= b</code></li>
<li>Инкремента/декремента: <code>a++</code>, <code>++a</code>, <code>a--</code>, <code>--a</code></li>
<li>Арифметические: <code>+a</code>, <code>-a</code>, <code>a + b</code>, <code>a - b</code>, <code>a * b</code>, <code>a / b</code>, <code>a % b</code></li>
<li>Битовые: <code>~a</code>, <code>a &amp; b</code>, <code>a | b</code>, <code>a ^ b</code>, <code>a &lt;&lt; b</code>, <code>a &gt;&gt; b</code></li>
<li>Логические: <code>!a</code>, <code>a &amp;&amp; b</code>, <code>a || b</code></li>
<li>Сравнения: <code>a == b</code>, <code>a != b</code>, <code>a &lt; b</code>, <code>a &gt; b</code>, <code>a &lt;= b</code>, <code>a &gt;= b</code></li>
<li>Индексации: <code>a[b]</code></li>
<li>Вызова: <code>a(b)</code></li>
<li>Потокового ввода/вывода: <code>std::cin &gt;&gt; a</code>, <code>std::cout &lt;&lt; a</code></li>
<li>Доступа к полю: <code>a-&gt;b</code></li>
</ul>
<blockquote>
<p>Я перечислил большинство операторов, но если ты хочешь увидеть ещё парочку экзотичесих или узнать как определить тот или иной оператор &ndash; посмотри <a href="https://en.cppreference.com/w/cpp/language/operators">здесь</a>.</p>
</blockquote>
<p>Давай рассмотрим парочку моментов, которые пригодятся тебе при переопределении любого оператора.</p>
<h3 id="возвращаем-себя">Возвращаем себя</h3>
<p>Для примера, переопределим ещё постфиксный оператор &ldquo;++&rdquo; &ndash; он будет &ldquo;доливать&rdquo; 1 миллилитр кофе:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Coffee</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;Аdded 1ml of &#34;</span> <span class="o">&lt;&lt;</span> <span class="n">m_type</span> <span class="o">&lt;&lt;</span> <span class="s">&#34;.&#34;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">m_volume</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><blockquote>
<p>Обрати внимание, что я указал int в параметрах &ndash; он нужен только для того, чтобы различать переопределение постфиксного оператора от префиксного.
Для префиксного оператора в параметрах ничего не указывается: <code>Coffee&amp; operator++()</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Coffee</span> <span class="nf">c1</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="c1">// Constructed 100ml cup of hot americano coffee. 
</span><span class="c1"></span><span class="n">c1</span><span class="o">++</span><span class="p">;</span>
<span class="c1">// Added 1ml of americano.
</span><span class="c1"></span><span class="n">c1</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="c1">// Drank 101ml of americano.
</span></code></pre></div><p>Обрати внимание на то, что мы возвращаем сами себя &ndash; Coffee&amp; (объект по ссылке). Можно и без этого, но благодаря этому можно делать так:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Coffee</span> <span class="nf">c1</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="c1">// Constructed 200ml cup of hot americano coffee. 
</span><span class="c1"></span><span class="p">(</span><span class="n">c1</span><span class="o">++</span><span class="p">).</span><span class="n">drink</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
<span class="c1">// Added 1ml of americano.
</span><span class="c1">// Drank 101ml of americano.
</span></code></pre></div><p>Если тебе не нужно такое поведение, то можешь возвращать void.</p>
<h3 id="возвращаем-новый-объект">Возвращаем новый объект</h3>
<p>Иногда, нужно вернуть новый объект &ndash; чаще всего такое встречается с арифметическими операторами.</p>
<p>Давай переопределим оператор &ldquo;+&rdquo; &ndash; это мы будем сливать кофе из двух кружек в одну новую:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Coffee</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Coffee</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Создали пустую кружку
</span><span class="c1"></span>    <span class="n">Coffee</span> <span class="nf">new_cup</span><span class="p">(</span><span class="n">m_type</span><span class="p">,</span> <span class="n">m_temperature</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">// Сливаем туда себя и вторую кружку
</span><span class="c1"></span>    <span class="n">new_cup</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="n">new_cup</span> <span class="o">&lt;&lt;</span> <span class="n">other</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">new_cup</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Обрати внимание, что я возвращаю объект по значению (написал Coffee, а не Coffee&amp;) &ndash; в main() вернётся копия new_cup, а не она сама.</p>
<p>Вот как он используется и что выведется:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Coffee</span> <span class="nf">c1</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">125</span><span class="p">);</span>
<span class="c1">// Constructed 125ml cup of hot americano coffee. 
</span><span class="c1"></span><span class="n">Coffee</span> <span class="nf">c2</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
<span class="c1">// Constructed 25ml cup of hot americano coffee. 
</span><span class="c1"></span><span class="n">Coffee</span> <span class="n">c3</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span><span class="p">;</span>
<span class="c1">// Constructed 0ml cup of hot americano coffee. 
</span><span class="c1">// Poured 125ml of americano from one cup to another.
</span><span class="c1">// Poured 25ml of americano from one cup to another.
</span><span class="c1"></span><span class="n">c1</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="c1">// Drank 0ml of americano.
</span><span class="c1"></span><span class="n">c2</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="c1">// Drank 0ml of americano.
</span><span class="c1"></span><span class="n">c3</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="c1">// Drank 20ml of americano.
</span></code></pre></div><h3 id="не-возвращай-локальные-переменные-по-ссылке">Не возвращай локальные переменные по ссылке!</h3>
<p>В примере выше я возвращал локальную переменную new_cup по значению &ndash; а что было бы, если я вернул её по ссылке?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Coffee</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Coffee</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// Создали пустую кружку
</span><span class="c1"></span>    <span class="n">Coffee</span> <span class="nf">new_cup</span><span class="p">(</span><span class="n">m_type</span><span class="p">,</span> <span class="n">m_temperature</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="c1">// Сливаем туду себя и вторую кружку
</span><span class="c1"></span>    <span class="n">new_cup</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="n">new_cup</span> <span class="o">&lt;&lt;</span> <span class="n">other</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">new_cup</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>При компиляции я получаю следующие предупреждения:</p>
<pre tabindex="0"><code>test.cpp:105:12: warning: reference to local variable ‘new_cup’ returned [-Wreturn-local-addr]
105 |     return new_cup;
    |            ^~~~~~~
test.cpp:101:12: note: declared here
101 |     Coffee new_cup(m_type, m_temperature, 0);
    |            ^~~~~~~
</code></pre><p>При запуске я ловлю экстренное прерывание программы:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Coffee</span> <span class="nf">c1</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">125</span><span class="p">);</span>
<span class="c1">// Constructed 125ml cup of hot americano coffee. 
</span><span class="c1"></span><span class="n">Coffee</span> <span class="nf">c2</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
<span class="c1">// Constructed 25ml cup of hot americano coffee. 
</span><span class="c1"></span><span class="n">Coffee</span><span class="o">&amp;</span> <span class="n">c3</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span><span class="p">;</span>
<span class="c1">// Constructed 0ml cup of hot americano coffee. 
</span><span class="c1">// Poured 125ml of americano from one cup to another.
</span><span class="c1">// Poured 25ml of americano from one cup to another.
</span><span class="c1">// Destructed americano.
</span><span class="c1"></span><span class="n">c1</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="c1">// Drank 0ml of americano.
</span><span class="c1"></span><span class="n">c2</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="c1">// Drank 0ml of americano.
</span><span class="c1"></span><span class="n">c3</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="c1">// Segmentation fault (core dumped)
</span></code></pre></div><p>Вот последовательность событий:</p>
<ul>
<li>Вызов operator+()</li>
<li>Создание локальной переменной new_cup</li>
<li>Вызов операторов &ldquo;переливания&rdquo; для this и other</li>
<li>Возвращение new_cup в main и сохранение его в c3 (обрати внимание, что я указал тип переменной как Coffee&amp;, чтобы не было копирования)</li>
<li>Удаление локальной переменной new_cup (память под этот объект полностью освобождена)</li>
<li>Выход из operator+()</li>
<li>Вызов drink() для нормальных c1 и c2</li>
<li>Попытка вызвать drink() у объекта c3, которого уже не существует</li>
</ul>
<p>Если сложно понять что происходит, то можно представить что new_cup возвращается через указатель:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="n">Coffee</span><span class="o">*</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="n">Coffee</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Coffee</span> <span class="nf">new_cup</span><span class="p">(</span><span class="n">m_type</span><span class="p">,</span> <span class="n">m_temperature</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">new_cup</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="n">new_cup</span> <span class="o">&lt;&lt;</span> <span class="n">other</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">new_cup</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>А в main():</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// Вывод такой же как в прошлом примере
</span><span class="c1"></span><span class="n">Coffee</span> <span class="nf">c1</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">125</span><span class="p">);</span>
<span class="n">Coffee</span> <span class="nf">c2</span><span class="p">(</span><span class="s">&#34;americano&#34;</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>
<span class="n">Coffee</span><span class="o">*</span> <span class="n">c3</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">c2</span><span class="p">;</span>
<span class="n">c1</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="n">c2</span><span class="p">.</span><span class="n">drink</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="n">c3</span><span class="o">-&gt;</span><span class="n">drink</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
</code></pre></div><h1 id="заключение">Заключение</h1>
<p>Уфффф! Если операторы ещё более-менее понятны, то вот с этими ссылками было жёстко!</p>
<p>Ладно, я надеюсь, что у меня получилось разобрать и собрать у тебя в голове этот паззл. Если нет, то пиши &ndash; я отвечу на все вопросы.</p>
<p>Дальше на очереди &ndash; окончательно разбираемся с конструкторами.</p>

    <hr>
    <div align="center">
        <a href="https://kee-reel.com/cpp/operators.html#top">▲ В начало ▲</a>
    </div>
    
        <hr>
        <div style="display: flex; justify-content: space-between;">
            
                <a href="https://kee-reel.com/cpp/classes.html">◀ Классы</a>
            
            
                <a href="https://kee-reel.com/cpp/constructors.html">Конструкторы, оператор присваивания и деструктор ▶</a>
            
        </div>
    

			</section>
		</div>
	</div>

    <footer>
    <hr>
    <div align="center">
        Home server: Raspberry Pi 4<br>
        Temperature: <br>
Uptime: 
    </div>
</footer>

</body>
</html>
